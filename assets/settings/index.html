<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ENTSO-E Price Settings</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
    <style>
      :root {
        color-scheme: light dark;
        font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      }

      body {
        margin: 0;
        padding: 24px;
        background: #f5f7fa;
        color: #202431;
      }

      h1,
      h2 {
        margin: 0 0 12px;
        font-weight: 600;
      }

      p {
        margin: 0 0 12px;
        line-height: 1.5;
      }

      header {
        margin-bottom: 24px;
      }

      .card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
        padding: 20px;
        margin-bottom: 24px;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin-bottom: 16px;
      }

      .controls input[type="search"],
      .controls input[type="number"],
      textarea {
        flex: 1 1 220px;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #d0d7e2;
        background: #fdfefe;
        font-size: 14px;
      }

      textarea {
        min-height: 180px;
        resize: vertical;
        font-family: 'JetBrains Mono', 'SFMono-Regular', Consolas, monospace;
      }

      button {
        border: none;
        border-radius: 8px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        background: #1e88e5;
        color: #fff;
        transition: transform 0.1s ease, box-shadow 0.1s ease;
      }

      button.secondary {
        background: #e2e8f0;
        color: #1f2937;
      }

      button:active {
        transform: translateY(1px);
        box-shadow: none;
      }

      .zone-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 12px;
      }

      .zone-card {
        border: 1px solid #dfe6f3;
        border-radius: 10px;
        padding: 12px;
        background: #fbfdff;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .zone-card h3 {
        margin: 0;
        font-size: 16px;
      }

      .zone-card code {
        background: rgba(30, 136, 229, 0.08);
        padding: 2px 6px;
        border-radius: 6px;
        font-size: 13px;
        word-break: break-all;
      }

      .status {
        font-size: 13px;
        color: #2563eb;
        min-height: 18px;
      }

      .currency-row {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      @media (max-width: 640px) {
        body {
          padding: 16px;
        }
        .zone-list {
          grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        }
      }
    </style>
    <script
      type="text/javascript"
      src="/homey.js"
      data-origin="settings"
    ></script>
  </head>
  <body>
    <header>
      <h1>ENTSO-E Day-Ahead Prices</h1>
      <p>Select your electricity price area, provide your API token and (optionally) enable SEK conversion. Changes are saved automatically.</p>
    </header>

    <main>
      <section class="card">
        <h2>Zone Selection</h2>
        <p>Pick an ISO country code or a specific EIC. Clicking a zone copies the EIC to your clipboard and stores it as <code>entsoe_area_eic</code>.</p>
        <div class="controls">
          <input id="search" type="search" placeholder="Search for SE3, Sweden, 10YSE-3..." aria-label="Search price areas" />
          <button id="detect" type="button">Detect Country</button>
          <button id="download" type="button" class="secondary">Download Map JSON</button>
        </div>
        <div id="zoneList" class="zone-list" role="list"></div>
        <div class="status" id="zoneStatus" role="status" aria-live="polite"></div>
      </section>

      <section class="card">
        <h2>Currency Conversion</h2>
        <div class="currency-row">
          <label>
            <input type="checkbox" id="useConversion" />
            Enable EUR -> SEK conversion
          </label>
          <label>
            EUR -> SEK:
            <input id="fxRate" type="number" inputmode="decimal" step="0.0001" min="0" placeholder="11.20" />
          </label>
        </div>
        <div class="status" id="currencyStatus" role="status" aria-live="polite"></div>
      </section>

      <section class="card">
        <h2>Custom Area Map</h2>
        <p>Paste your customised <code>entsoe_area_map.json</code> below or reset to the bundled map. The map is stored in Homey settings.</p>
        <textarea id="mapEditor" spellcheck="false" aria-label="ENTSO-E area map JSON"></textarea>
        <div class="controls">
          <button id="resetMap" type="button" class="secondary">Reset to bundled map</button>
          <button id="saveMap" type="button">Save map JSON</button>
          <span class="status" id="mapStatus" role="status" aria-live="polite"></span>
        </div>
      </section>
    </main>

    <script>
      (function () {
        const isoLabels = {
          SE: 'Sweden',
          NO: 'Norway',
          DK: 'Denmark',
          FI: 'Finland',
          DE: 'Germany',
          FR: 'France',
          NL: 'Netherlands',
          BE: 'Belgium',
          AT: 'Austria',
          PL: 'Poland',
          EE: 'Estonia',
          LV: 'Latvia',
          LT: 'Lithuania',
          IE: 'Ireland',
          GB: 'Great Britain',
          PT: 'Portugal',
          ES: 'Spain',
          IT: 'Italy',
          CH: 'Switzerland',
          CZ: 'Czech Republic',
          SK: 'Slovakia',
          SI: 'Slovenia',
          HU: 'Hungary',
          RO: 'Romania',
          BG: 'Bulgaria',
          HR: 'Croatia',
          GR: 'Greece',
          RS: 'Serbia',
          BA: 'Bosnia & Herzegovina',
          ME: 'Montenegro',
          MK: 'North Macedonia',
          AL: 'Albania',
          TR: 'Turkey'
        };

        const state = {
          map: {},
          bundledMap: {},
          selectedEic: '',
          useConversion: false,
          fxRate: '',
          bridgeReady: false
        };

        const zoneListEl = document.getElementById('zoneList');
        const zoneStatusEl = document.getElementById('zoneStatus');
        const searchEl = document.getElementById('search');
        const detectBtn = document.getElementById('detect');
        const downloadBtn = document.getElementById('download');
        const useConversionEl = document.getElementById('useConversion');
        const fxRateEl = document.getElementById('fxRate');
        const currencyStatusEl = document.getElementById('currencyStatus');
        const mapEditorEl = document.getElementById('mapEditor');
        const mapStatusEl = document.getElementById('mapStatus');
        const resetMapBtn = document.getElementById('resetMap');
        const saveMapBtn = document.getElementById('saveMap');

        const permissionsPolicy = document.permissionsPolicy;
        function allowsFeature(feature) {
          if (!permissionsPolicy || typeof permissionsPolicy.allowsFeature !== 'function') {
            return true;
          }
          try {
            return permissionsPolicy.allowsFeature(feature);
          } catch (error) {
            return true;
          }
        }

        function sandboxAllowsDownloads() {
          const frames = [];
          try {
            frames.push(window.frameElement || null);
          } catch (error) {
            frames.push(null);
          }
          try {
            if (window.top && window.top !== window) {
              frames.push(window.top.frameElement || null);
            }
          } catch (error) {
            frames.push(null);
          }

          for (const frame of frames) {
            if (!frame) {
              continue;
            }
            const sandboxAttr = frame.getAttribute('sandbox');
            if (!sandboxAttr) {
              continue;
            }
            const tokens = sandboxAttr.split(/\s+/).filter(Boolean);
            if (!tokens.includes('allow-downloads')) {
              return false;
            }
          }
          return true;
        }

        let clipboardSupported = allowsFeature('clipboard-write') && !!(navigator.clipboard && typeof navigator.clipboard.writeText === 'function');
        if (clipboardSupported && navigator.permissions && typeof navigator.permissions.query === 'function') {
          navigator.permissions
            .query({ name: 'clipboard-write' })
            .then((status) => {
              clipboardSupported = status.state !== 'denied';
              status.onchange = () => {
                clipboardSupported = status.state !== 'denied';
              };
            })
            .catch(() => {
              clipboardSupported = false;
            });
        }

        const downloadsSupported = sandboxAllowsDownloads();

        const bridge = {
          set(key, value) {
            window.parent?.postMessage({ type: 'homey:setSetting', key, value }, '*');
            if (window.Homey && typeof window.Homey.set === 'function') {
              window.Homey.set(key, value, () => {});
            }
          },
          get(key, callback) {
            if (window.Homey && typeof window.Homey.get === 'function') {
              window.Homey.get(key, callback);
              return;
            }
            const handler = (event) => {
              if (!event?.data || event.data.type !== 'homey:settingValue' || event.data.key !== key) {
                return;
              }
              window.removeEventListener('message', handler);
              callback(event.data.value);
            };
            window.addEventListener('message', handler);
            window.parent?.postMessage({ type: 'homey:getSetting', key }, '*');
          }
        };

        async function loadBundledMap() {
          const response = await fetch('/app/com.melcloud.optimize/assets/entsoe_area_map.json', { cache: 'no-cache' });
          if (!response.ok) {
            throw new Error('Failed to load bundled entsoe_area_map.json');
          }
          state.bundledMap = await response.json();
          if (!Object.keys(state.map).length) {
            state.map = JSON.parse(JSON.stringify(state.bundledMap));
          }
        }

        function renderZoneList(filterText = '') {
          const query = filterText.trim().toLowerCase();
          zoneListEl.innerHTML = '';

          const entries = Object.entries(state.map)
            .sort(([isoA], [isoB]) => isoA.localeCompare(isoB));

          for (const [iso, eics] of entries) {
            const label = isoLabels[iso] || iso;
            for (const eic of eics) {
              const display = `${iso} · ${label}`;
              const haystack = `${iso} ${label} ${eic}`.toLowerCase();
              if (query && !haystack.includes(query)) {
                continue;
              }
              const card = document.createElement('article');
              card.className = 'zone-card';
              card.setAttribute('role', 'listitem');

              const heading = document.createElement('h3');
              heading.textContent = display;
              card.appendChild(heading);

              const codeEl = document.createElement('code');
              codeEl.textContent = eic;
              card.appendChild(codeEl);

              const actionBtn = document.createElement('button');
              actionBtn.type = 'button';
              actionBtn.textContent = 'Use this zone';
              actionBtn.addEventListener('click', () => selectZone(iso, eic));
              card.appendChild(actionBtn);

              if (state.selectedEic === eic) {
                card.style.borderColor = '#1e88e5';
                card.style.boxShadow = '0 0 0 1px rgba(30, 136, 229, 0.25)';
              }

              zoneListEl.appendChild(card);
            }
          }

          if (!zoneListEl.children.length) {
            const empty = document.createElement('p');
            empty.textContent = 'No matches found. Try a different search term or reset the map.';
            zoneListEl.appendChild(empty);
          }
        }

        async function copyToClipboard(text) {
          if (!clipboardSupported) {
            return false;
          }
          try {
            await navigator.clipboard.writeText(text);
            return true;
          } catch (error) {
            clipboardSupported = false;
            return false;
          }
        }

        function notifyStatus(el, message) {
          el.textContent = message;
          if (!message) {
            return;
          }
          setTimeout(() => {
            if (el.textContent === message) {
              el.textContent = '';
            }
          }, 4000);
        }

        async function selectZone(iso, eic) {
          state.selectedEic = eic;
          renderZoneList(searchEl.value || '');
          const copied = await copyToClipboard(eic);
          bridge.set('entsoe_area_eic', eic);
          notifyStatus(
            zoneStatusEl,
            copied
              ? `Saved ${eic} and copied to clipboard.`
              : `Saved ${eic}. Clipboard copy is not available in this Homey settings view.`
          );
        }

        function detectCountry() {
          const language = navigator.language || navigator.userLanguage || '';
          const parts = language.split('-');
          const iso = parts.length > 1 ? parts[1].toUpperCase() : parts[0]?.toUpperCase() || '';
          if (!iso || !state.map[iso]) {
            notifyStatus(zoneStatusEl, 'Could not detect a matching ENTSO-E zone for this locale.');
            return;
          }
          const eic = state.map[iso][0];
          selectZone(iso, eic);
        }

        function downloadMap() {
          const mapJson = JSON.stringify(state.map, null, 2);
          const blob = new Blob([mapJson], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'entsoe_area_map.json';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }

        function saveCurrencySettings() {
          bridge.set('use_currency_conversion', useConversionEl.checked);
          notifyStatus(currencyStatusEl, useConversionEl.checked ? 'Currency conversion enabled.' : 'Currency conversion disabled.');

          const value = fxRateEl.value.trim();
          if (value) {
            const numeric = Number(value);
            if (!Number.isFinite(numeric) || numeric <= 0) {
              notifyStatus(currencyStatusEl, 'Invalid EUR -> SEK rate. Use positive numbers like 11.2');
              return;
            }
            bridge.set('fx_rate_eur_to_sek', numeric);
            notifyStatus(currencyStatusEl, `Saved conversion rate ${numeric}.`);
          }
        }

        function resetMap() {
          state.map = JSON.parse(JSON.stringify(state.bundledMap));
          mapEditorEl.value = JSON.stringify(state.map, null, 2);
          renderZoneList(searchEl.value || '');
          notifyStatus(mapStatusEl, 'Map reset to bundled version. Remember to click Save map JSON.');
        }

        function saveMap() {
          try {
            const parsed = JSON.parse(mapEditorEl.value);
            state.map = parsed;
            bridge.set('entsoe_area_map', JSON.stringify(parsed));
            renderZoneList(searchEl.value || '');
            notifyStatus(mapStatusEl, 'Saved custom entsoe_area_map JSON.');
          } catch (error) {
            console.error('Failed to parse map JSON', error);
            notifyStatus(mapStatusEl, 'Invalid JSON – please fix formatting before saving.');
          }
        }

        function hydrateFromSettings() {
          bridge.get('entsoe_area_eic', (value) => {
            if (typeof value === 'string' && value.trim()) {
              state.selectedEic = value.trim();
              renderZoneList(searchEl.value || '');
            }
          });
          bridge.get('entsoe_area_map', (value) => {
            if (!value) {
              mapEditorEl.value = JSON.stringify(state.map, null, 2);
              return;
            }
            try {
              const parsed = typeof value === 'string' ? JSON.parse(value) : value;
              if (parsed && typeof parsed === 'object') {
                state.map = parsed;
                mapEditorEl.value = JSON.stringify(parsed, null, 2);
                renderZoneList(searchEl.value || '');
              }
            } catch (error) {
              console.warn('Stored entsoe_area_map is not valid JSON', error);
              mapEditorEl.value = JSON.stringify(state.map, null, 2);
            }
          });
          bridge.get('use_currency_conversion', (value) => {
            useConversionEl.checked = value === true;
          });
          bridge.get('fx_rate_eur_to_sek', (value) => {
            if (value != null && value !== '') {
              fxRateEl.value = value;
            }
          });
        }

        async function init() {
          try {
            await loadBundledMap();
            mapEditorEl.value = JSON.stringify(state.map, null, 2);
            renderZoneList();
            hydrateFromSettings();
          } catch (error) {
            console.error(error);
            notifyStatus(zoneStatusEl, 'Failed to load entsoe_area_map.json.');
          }
        }

        searchEl.addEventListener('input', (event) => {
          renderZoneList(event.target.value || '');
        });
        detectBtn.addEventListener('click', detectCountry);
        if (downloadBtn) {
          if (downloadsSupported) {
            downloadBtn.addEventListener('click', downloadMap);
          } else {
            downloadBtn.disabled = true;
            downloadBtn.classList.add('secondary');
            downloadBtn.textContent = 'Download not available here';
            downloadBtn.setAttribute('aria-disabled', 'true');
            downloadBtn.title = 'Downloads are blocked in this Homey settings view.';
          }
        }
        useConversionEl.addEventListener('change', saveCurrencySettings);
        fxRateEl.addEventListener('change', saveCurrencySettings);
        resetMapBtn.addEventListener('click', resetMap);
        saveMapBtn.addEventListener('click', saveMap);

        document.addEventListener('DOMContentLoaded', init);
      })();
    </script>
  </body>
</html>
