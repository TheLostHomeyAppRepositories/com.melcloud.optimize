<!DOCTYPE html>
<html>
  <head>
    <script
      type="text/javascript"
      src="/homey.js"
      data-origin="settings"
    ></script>
  </head>
  <body>
    <header class="homey-header">
      <h1 class="homey-title">MELCloud Optimizer Settings</h1>
      <p class="homey-subtitle">Configure your credentials and temperature settings</p>
    </header>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">MELCloud Credentials</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="melcloud_user">Email</label>
        <input class="homey-form-input" id="melcloud_user" type="text" value="" />
      </div>
      <div class="homey-form-group">
        <label class="homey-form-label" for="melcloud_pass">Password</label>
        <input class="homey-form-input" id="melcloud_pass" type="password" value="" />
      </div>
      <div class="homey-form-group">
        <label class="homey-form-label" for="device_id">Device ID</label>
        <input class="homey-form-input" id="device_id" type="text" value="" />
        <p class="homey-form-helper">The ID of your heat pump device in MELCloud</p>
      </div>
      <div class="homey-form-group">
        <label class="homey-form-label" for="building_id">Building ID</label>
        <input class="homey-form-input" id="building_id" type="text" value="" />
        <p class="homey-form-helper">The ID of the building where your heat pump is located</p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Tibber API</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="tibber_token">API Token</label>
        <input class="homey-form-input" id="tibber_token" type="password" value="" />
        <p class="homey-form-helper">Get your token from <a href="https://developer.tibber.com/" target="_blank">https://developer.tibber.com/</a></p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">OpenAI API</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="openai_api_key">API Key</label>
        <input class="homey-form-input" id="openai_api_key" type="password" value="" />
        <p class="homey-form-helper">Used for weekly calibration. Get your key from <a href="https://platform.openai.com/api-keys" target="_blank">https://platform.openai.com/api-keys</a></p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Temperature Settings</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="min_temp">Minimum Temperature (째C)</label>
        <input class="homey-form-input" id="min_temp" type="number" min="16" max="22" step="0.5" value="18" />
      </div>
      <div class="homey-form-group">
        <label class="homey-form-label" for="max_temp">Maximum Temperature (째C)</label>
        <input class="homey-form-input" id="max_temp" type="number" min="20" max="26" step="0.5" value="24" />
      </div>
      <div class="homey-form-group">
        <label class="homey-form-label" for="temp_step_max">Maximum Temperature Step (째C)</label>
        <input class="homey-form-input" id="temp_step_max" type="number" min="0.1" max="2.0" step="0.1" value="0.5" />
      </div>
      <div class="homey-form-group">
        <label class="homey-form-label" for="initial_k">Initial K Factor</label>
        <input class="homey-form-input" id="initial_k" type="number" min="0.1" max="1.0" step="0.05" value="0.3" />
        <p class="homey-form-helper">Initial thermal response factor. Will be automatically calibrated over time.</p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Weather Integration</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="use_weather_data">Use Weather Data</label>
        <label class="homey-form-checkbox">
          <input type="checkbox" id="use_weather_data" checked />
          <span>Enable weather data integration (Met.no API)</span>
        </label>
        <p class="homey-form-helper">Uses weather data to improve temperature optimization based on outdoor conditions</p>
      </div>

      <div class="homey-form-group">
        <label class="homey-form-label" for="weather_location">Your Location</label>
        <div class="homey-form-row">
          <div class="homey-form-col">
            <label class="homey-form-label" for="latitude">Latitude</label>
            <input class="homey-form-input" id="latitude" type="number" step="0.000001" placeholder="e.g., 51.5074" />
            <p class="homey-form-helper">Decimal degrees (e.g., 51.5074 for London)</p>
          </div>
          <div class="homey-form-col">
            <label class="homey-form-label" for="longitude">Longitude</label>
            <input class="homey-form-input" id="longitude" type="number" step="0.000001" placeholder="e.g., -0.1278" />
            <p class="homey-form-helper">Decimal degrees (e.g., -0.1278 for London)</p>
          </div>
        </div>
        <button id="detect-location" class="homey-button-primary">Detect My Location</button>
        <p class="homey-form-helper">You can find your coordinates using <a href="https://www.latlong.net/" target="_blank">LatLong.net</a> or similar services</p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Comfort Profiles</legend>
      <div class="homey-form-group">
        <label class="homey-form-label">Day Profile (Higher Comfort)</label>
        <div class="homey-form-row">
          <div class="homey-form-col">
            <label class="homey-form-label" for="day_start_hour">Start Hour</label>
            <input class="homey-form-input" id="day_start_hour" type="number" min="0" max="23" step="1" value="6" />
            <p class="homey-form-helper">Hour when day profile begins (0-23)</p>
          </div>
          <div class="homey-form-col">
            <label class="homey-form-label" for="day_end_hour">End Hour</label>
            <input class="homey-form-input" id="day_end_hour" type="number" min="0" max="23" step="1" value="22" />
            <p class="homey-form-helper">Hour when day profile ends (0-23)</p>
          </div>
        </div>
      </div>

      <div class="homey-form-group">
        <label class="homey-form-label">Temperature Adjustments</label>
        <div class="homey-form-row">
          <div class="homey-form-col">
            <label class="homey-form-label" for="night_temp_reduction">Night Reduction</label>
            <input class="homey-form-input" id="night_temp_reduction" type="number" min="0" max="5" step="0.5" value="2" />
            <p class="homey-form-helper">Temperature reduction during night (째C)</p>
          </div>
          <div class="homey-form-col">
            <label class="homey-form-label" for="pre_heat_hours">Pre-heat Hours</label>
            <input class="homey-form-input" id="pre_heat_hours" type="number" min="0" max="3" step="0.5" value="1" />
            <p class="homey-form-helper">Hours before day start to begin pre-heating</p>
          </div>
        </div>
      </div>

      <div class="homey-form-group">
        <label class="homey-form-label">Time Zone</label>
        <div class="homey-form-row">
          <div class="homey-form-col">
            <label class="homey-form-label" for="time_zone_offset">UTC Offset</label>
            <select class="homey-form-input" id="time_zone_offset">
              <option value="-12">UTC-12:00</option>
              <option value="-11">UTC-11:00</option>
              <option value="-10">UTC-10:00</option>
              <option value="-9">UTC-09:00</option>
              <option value="-8">UTC-08:00</option>
              <option value="-7">UTC-07:00</option>
              <option value="-6">UTC-06:00</option>
              <option value="-5">UTC-05:00</option>
              <option value="-4">UTC-04:00</option>
              <option value="-3">UTC-03:00</option>
              <option value="-2">UTC-02:00</option>
              <option value="-1">UTC-01:00</option>
              <option value="0">UTC+00:00</option>
              <option value="1">UTC+01:00</option>
              <option value="2" selected>UTC+02:00</option>
              <option value="3">UTC+03:00</option>
              <option value="4">UTC+04:00</option>
              <option value="5">UTC+05:00</option>
              <option value="5.5">UTC+05:30</option>
              <option value="6">UTC+06:00</option>
              <option value="7">UTC+07:00</option>
              <option value="8">UTC+08:00</option>
              <option value="9">UTC+09:00</option>
              <option value="9.5">UTC+09:30</option>
              <option value="10">UTC+10:00</option>
              <option value="11">UTC+11:00</option>
              <option value="12">UTC+12:00</option>
              <option value="13">UTC+13:00</option>
            </select>
            <p class="homey-form-helper">Your local time zone offset from UTC</p>
          </div>
          <div class="homey-form-col">
            <label class="homey-form-label" for="use_dst">Daylight Saving Time</label>
            <label class="homey-form-checkbox">
              <input type="checkbox" id="use_dst" checked />
              <span>Automatically adjust for DST</span>
            </label>
            <p class="homey-form-helper">Automatically adjust for daylight saving time changes</p>
          </div>
        </div>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Advanced Settings</legend>
      <div class="homey-form-group">
        <label class="homey-form-label" for="log_level">Log Level</label>
        <select class="homey-form-input" id="log_level">
          <option value="0">Debug (Verbose)</option>
          <option value="1" selected>Info (Normal)</option>
          <option value="2">Warning (Minimal)</option>
          <option value="3">Error (Only Errors)</option>
        </select>
        <p class="homey-form-helper">Controls the amount of information logged. Debug provides the most detailed logs.</p>
      </div>
    </fieldset>

    <fieldset class="homey-form-fieldset">
      <legend class="homey-form-legend">Manual Triggers</legend>
      <div class="homey-form-group">
        <p class="homey-form-helper">Use these buttons to manually trigger operations for testing purposes.</p>
        <div style="display: flex; gap: 10px; margin-top: 10px;">
          <button id="run_hourly" class="homey-button">Run Hourly Optimization</button>
          <button id="run_weekly" class="homey-button">Run Weekly Calibration</button>
          <button id="test_log" class="homey-button">Test Logging</button>
        </div>
        <p id="trigger_result" style="margin-top: 10px; font-style: italic;"></p>
      </div>
    </fieldset>

    <button id="save" class="homey-button-primary-full">Save changes</button>

    <script type="text/javascript">
      function onHomeyReady(Homey) {
        console.log('onHomeyReady called - Settings page initialized');

        // Tell Homey we're ready to be displayed
        Homey.ready();
        console.log('Homey.ready() called');

        // Get elements
        const melcloudUserElement = document.getElementById("melcloud_user");
        const melcloudPassElement = document.getElementById("melcloud_pass");
        const deviceIdElement = document.getElementById("device_id");
        const buildingIdElement = document.getElementById("building_id");
        const tibberTokenElement = document.getElementById("tibber_token");
        const openaiApiKeyElement = document.getElementById("openai_api_key");
        const minTempElement = document.getElementById("min_temp");
        const maxTempElement = document.getElementById("max_temp");
        const tempStepMaxElement = document.getElementById("temp_step_max");
        const initialKElement = document.getElementById("initial_k");
        const useWeatherDataElement = document.getElementById("use_weather_data");
        const latitudeElement = document.getElementById("latitude");
        const longitudeElement = document.getElementById("longitude");
        const detectLocationButton = document.getElementById("detect-location");
        const dayStartHourElement = document.getElementById("day_start_hour");
        const dayEndHourElement = document.getElementById("day_end_hour");
        const nightTempReductionElement = document.getElementById("night_temp_reduction");
        const preHeatHoursElement = document.getElementById("pre_heat_hours");
        const timeZoneOffsetElement = document.getElementById("time_zone_offset");
        const useDstElement = document.getElementById("use_dst");
        const logLevelElement = document.getElementById("log_level");
        const saveElement = document.getElementById("save");
        const runHourlyElement = document.getElementById("run_hourly");
        const runWeeklyElement = document.getElementById("run_weekly");
        const testLogElement = document.getElementById("test_log");
        const triggerResultElement = document.getElementById("trigger_result");

        // Load current settings
        Homey.get("melcloud_user", function (err, value) {
          if (err) return Homey.alert(err);
          if (value) melcloudUserElement.value = value;
        });

        Homey.get("melcloud_pass", function (err, value) {
          if (err) return Homey.alert(err);
          if (value) melcloudPassElement.value = value;
        });

        Homey.get("device_id", function (err, value) {
          if (err) return Homey.alert(err);
          if (value) deviceIdElement.value = value;
        });

        Homey.get("building_id", function (err, value) {
          if (err) return Homey.alert(err);
          if (value) buildingIdElement.value = value;
        });

        Homey.get("tibber_token", function (err, value) {
          if (err) return Homey.alert(err);
          if (value) tibberTokenElement.value = value;
        });

        Homey.get("openai_api_key", function (err, value) {
          if (err) return Homey.alert(err);
          if (value) openaiApiKeyElement.value = value;
        });

        Homey.get("min_temp", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) minTempElement.value = value;
        });

        Homey.get("max_temp", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) maxTempElement.value = value;
        });

        Homey.get("temp_step_max", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) tempStepMaxElement.value = value;
        });

        Homey.get("initial_k", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) initialKElement.value = value;
        });

        Homey.get("log_level", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) logLevelElement.value = value;
        });

        Homey.get("use_weather_data", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) useWeatherDataElement.checked = value;
        });

        Homey.get("latitude", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) latitudeElement.value = value;
        });

        Homey.get("longitude", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) longitudeElement.value = value;
        });

        // Load comfort profile settings
        Homey.get("day_start_hour", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) dayStartHourElement.value = value;
        });

        Homey.get("day_end_hour", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) dayEndHourElement.value = value;
        });

        Homey.get("night_temp_reduction", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) nightTempReductionElement.value = value;
        });

        Homey.get("pre_heat_hours", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) preHeatHoursElement.value = value;
        });

        // Load time zone settings
        Homey.get("time_zone_offset", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) timeZoneOffsetElement.value = value;
        });

        Homey.get("use_dst", function (err, value) {
          if (err) return Homey.alert(err);
          if (value !== undefined) useDstElement.checked = value;
        });

        // Add event listener for the detect location button
        detectLocationButton.addEventListener('click', function(e) {
          e.preventDefault();

          // Show a message that this is a browser-based feature
          Homey.alert('This feature uses your browser\'s location. Please allow location access when prompted.');

          // Use browser geolocation API
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              function(position) {
                // Success callback
                latitudeElement.value = position.coords.latitude;
                longitudeElement.value = position.coords.longitude;
                Homey.alert('Location detected successfully! Please save your settings.');
              },
              function(error) {
                // Error callback
                let errorMessage = 'Could not detect your location. ';
                switch(error.code) {
                  case error.PERMISSION_DENIED:
                    errorMessage += 'Location permission was denied.';
                    break;
                  case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Location information is unavailable.';
                    break;
                  case error.TIMEOUT:
                    errorMessage += 'The request to get location timed out.';
                    break;
                  default:
                    errorMessage += 'An unknown error occurred.';
                    break;
                }
                Homey.alert(errorMessage);
              }
            );
          } else {
            Homey.alert('Geolocation is not supported by your browser. Please enter coordinates manually.');
          }
        });

        // Save settings
        saveElement.addEventListener("click", function (e) {
          // Save all settings
          Homey.set("melcloud_user", melcloudUserElement.value, function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("melcloud_pass", melcloudPassElement.value, function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("device_id", deviceIdElement.value, function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("building_id", parseInt(buildingIdElement.value) || 0, function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("tibber_token", tibberTokenElement.value, function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("openai_api_key", openaiApiKeyElement.value, function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("min_temp", parseFloat(minTempElement.value), function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("max_temp", parseFloat(maxTempElement.value), function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("temp_step_max", parseFloat(tempStepMaxElement.value), function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("initial_k", parseFloat(initialKElement.value), function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("log_level", parseInt(logLevelElement.value), function (err) {
            if (err) return Homey.alert(err);
          });

          Homey.set("use_weather_data", useWeatherDataElement.checked, function (err) {
            if (err) return Homey.alert(err);
          });

          // Save location settings
          const latitude = parseFloat(latitudeElement.value);
          const longitude = parseFloat(longitudeElement.value);

          if (!isNaN(latitude) && latitude >= -90 && latitude <= 90) {
            Homey.set("latitude", latitude, function (err) {
              if (err) return Homey.alert(err);
            });
          } else if (latitudeElement.value) {
            Homey.alert('Invalid latitude value. Must be between -90 and 90.');
            return;
          }

          if (!isNaN(longitude) && longitude >= -180 && longitude <= 180) {
            Homey.set("longitude", longitude, function (err) {
              if (err) return Homey.alert(err);
            });
          } else if (longitudeElement.value) {
            Homey.alert('Invalid longitude value. Must be between -180 and 180.');
            return;
          }

          // Save comfort profile settings
          const dayStartHour = parseInt(dayStartHourElement.value);
          if (!isNaN(dayStartHour) && dayStartHour >= 0 && dayStartHour <= 23) {
            Homey.set("day_start_hour", dayStartHour, function (err) {
              if (err) return Homey.alert(err);
            });
          }

          const dayEndHour = parseInt(dayEndHourElement.value);
          if (!isNaN(dayEndHour) && dayEndHour >= 0 && dayEndHour <= 23) {
            Homey.set("day_end_hour", dayEndHour, function (err) {
              if (err) return Homey.alert(err);
            });
          }

          const nightTempReduction = parseFloat(nightTempReductionElement.value);
          if (!isNaN(nightTempReduction) && nightTempReduction >= 0 && nightTempReduction <= 5) {
            Homey.set("night_temp_reduction", nightTempReduction, function (err) {
              if (err) return Homey.alert(err);
            });
          }

          const preHeatHours = parseFloat(preHeatHoursElement.value);
          if (!isNaN(preHeatHours) && preHeatHours >= 0 && preHeatHours <= 3) {
            Homey.set("pre_heat_hours", preHeatHours, function (err) {
              if (err) return Homey.alert(err);
            });
          }

          // Save time zone settings
          const timeZoneOffset = parseFloat(timeZoneOffsetElement.value);
          if (!isNaN(timeZoneOffset) && timeZoneOffset >= -12 && timeZoneOffset <= 14) {
            Homey.set("time_zone_offset", timeZoneOffset, function (err) {
              if (err) return Homey.alert(err);
            });
          }

          Homey.set("use_dst", useDstElement.checked, function (err) {
            if (err) return Homey.alert(err);
          });

          // Show success message
          Homey.alert('Settings saved successfully!');
        });

        // Run hourly optimization button
        // When clicked, this directly calls the runHourlyOptimizer method on the app
        runHourlyElement.addEventListener("click", function (e) {
          // Log to console for debugging
          console.log('Hourly optimization button clicked');
          alert('Hourly optimization button clicked - Will directly call runHourlyOptimizer()');

          // Disable button and show loading state
          runHourlyElement.disabled = true;
          triggerResultElement.textContent = "Running hourly optimization...";

          // Call the API to directly execute the runHourlyOptimizer method
          console.log('Calling API.getRunHourlyOptimizer() directly');
          Homey.api('GET', '/runHourlyOptimizer', {}, function(err, result) {
            if (err) {
              console.error('Error calling runHourlyOptimizer:', err);
              alert('Error calling runHourlyOptimizer: ' + err.message);
              runHourlyElement.disabled = false;
              triggerResultElement.textContent = "Error: " + err.message;
              return Homey.alert(err.message);
            }

            console.log('runHourlyOptimizer called successfully:', result);
            alert('runHourlyOptimizer called successfully');

            // Show success message
            runHourlyElement.disabled = false;
            triggerResultElement.textContent = "Hourly optimization completed successfully! Check the timeline for details.";
          });
        });

        // Run weekly calibration button
        // When clicked, this directly calls the runWeeklyCalibration method on the app
        runWeeklyElement.addEventListener("click", function (e) {
          // Log to console for debugging
          console.log('Weekly calibration button clicked');
          alert('Weekly calibration button clicked - Will directly call runWeeklyCalibration()');

          // Disable button and show loading state
          runWeeklyElement.disabled = true;
          triggerResultElement.textContent = "Running weekly calibration...";

          // Call the API to directly execute the runWeeklyCalibration method
          console.log('Calling API.getRunWeeklyCalibration() directly');
          Homey.api('GET', '/runWeeklyCalibration', {}, function(err, result) {
            if (err) {
              console.error('Error calling runWeeklyCalibration:', err);
              alert('Error calling runWeeklyCalibration: ' + err.message);
              runWeeklyElement.disabled = false;
              triggerResultElement.textContent = "Error: " + err.message;
              return Homey.alert(err.message);
            }

            console.log('runWeeklyCalibration called successfully:', result);
            alert('runWeeklyCalibration called successfully');

            // Show success message
            runWeeklyElement.disabled = false;
            triggerResultElement.textContent = "Weekly calibration completed successfully! Check the timeline for details.";
          });
        });

        // Test logging button
        // When clicked, this directly calls the testLogging method on the app
        testLogElement.addEventListener("click", function (e) {
          // Log to console for debugging
          console.log('Test logging button clicked');
          alert('Test logging button clicked - Will directly call testLogging()');

          // Disable button and show loading state
          testLogElement.disabled = true;
          triggerResultElement.textContent = "Testing logging...";

          // Call the API to directly execute the testLogging method
          console.log('Calling API.getTestLogging() directly');
          Homey.api('GET', '/testLogging', {}, function(err, result) {
            if (err) {
              console.error('Error calling testLogging:', err);
              alert('Error calling testLogging: ' + err.message);
              testLogElement.disabled = false;
              triggerResultElement.textContent = "Error: " + err.message;
              return Homey.alert(err.message);
            }

            console.log('testLogging called successfully:', result);
            alert('testLogging called successfully');

            // Show success message
            testLogElement.disabled = false;
            triggerResultElement.textContent = "Test logging completed successfully! Check the terminal for details.";
          });
        });
      }
    </script>
  </body>
</html>
